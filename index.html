<!DOCTYPE html>
<!-- saved from url=(0047)https://ruisantosdotme.github.io/esp32-web-ble/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>ESP32 Web BLE App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
<!--    
<link rel="icon" type="image/png" href="https://ruisantosdotme.github.io/esp32-web-ble/favicon.ico">
    <link rel="stylesheet" type="text/css" href="./ESP32 Web BLE App_files/style.css">
	-->
<style>
html {
    font-family: Arial, Helvetica, sans-serif;
    display: inline-block;
    //text-align: center;
}
h1 {
    font-size: 1.8rem;
    color: white;
}
h5 {
    font-size: 0.6rem;
    color: white;
}
.topnav { 
    overflow: hidden;
    background-color: #0A1128;
	text-align: center;
}
body {
    margin: 0;
}
.content {
    padding: 50px;
}
.card-grid {
    //max-width: 800px;
	max-width: 600px;
    margin: 0 auto;
    margin-bottom: 30px;
    display: grid;
    grid-gap: 2rem;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
	text-align: center;
}
.card {
    background-color: white;
    box-shadow: 2px 2px 12px 1px rgba(140,140,140,.5);
	text-align: center;
}

.card1 {
    background-color: white;
    box-shadow: 2px 2px 12px 1px rgba(140,140,140,.5);
	//1text-align: center;
	padding: 0px 20px; //separacion y x
}

button {
    color: white;
   // padding: 14px 20px;
	padding: 5px 5px;
    margin: 8px 0;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}

.onButton{
    background-color: #1b8a94;
}

.offButton{
    background-color: #5f6c6d;
}

.connectButton{
    background-color: #24af37;
}

.disconnectButton{
    background-color: #d13a30;
}

.gray-label { 
    color: #bebebe; 
    font-size: 1rem; 
}

.reading { 
    font-size:0.8rem;
	text-align: left;
}
</style>
</head>
<body>
    <div class="topnav">
        <h1>ESP32 Web BLE Aplicacion</h1>
		<h5>Control_riego_v6_BLE_grafec_Wifi.ino</h5>
    </div>
    <div class="content">  <!--0 -->
        <div class="card-grid"> <!-- 0.1 <br>-->
            <div class="card"> 
                <p>
                    <button id="connectBleButton" class="connectButton">Conectar</button>
	                <button id="disconnectBleButton" class="disconnectButton">Desconectar</button>
					
                </p>
                <p class="gray-label">Estado BLE: <strong><span id="bleState" style="color:#d13a30;">Desconectado</span></strong></p>
            
			 <button id="onButton" class="connectButton">ON</button>
                <button id="offButton" class="disconnectButton">OFF</button>
				
                <button id="infoButton" class="offButton">Info</button>
				<button id="relojButton" class="onButton">Reloj</button>
				
				<h2>Control Riego</h2>
				<button id="regarButton" class="connectButton">Regar</button>
				<input style="width: 30px;" type="number" id="quantity" name="quantity" min="1" max="10" value="1">
				<label for="ordenes">ordenes:</label>
				<select name="ordenes" id="ordenes" onchange="fseleccionar();">
				  <option value="">Seleccionar</option>
				  <option value="On.1">Activa proceso</option>
				  <option value="Off.1">Apaga Bomba</option>
				  <option value="Regar.1">Enciende Bomba</option>
				  <option value="L.">tiempo lectura sonda</option>				  
				  <option value="I.">L. infer</option>
				  <option value="S.">L. sup</option>
				  <option value="Eeprom.1">Eeprom</option>
				  <option value="B.1">tiempo bomba</option>
				  <option value="Dr.">dias de riego</option>
				  <option value="Mi."> minutos reloj</option>
				  <option value="D.">dia reloj</option>
				  <option value="M.">mes reloj</option>
				  <option value="R.D,h,m,dias">Establece riego</option>
				  <option value="Auto.1">automatico:1</option>
				  <option value="A.">año reloj</option>
				  <option value="H.">hora reloj</option>
				  <option value="Mb.">minuto que enciende</option>
				  <option value="Hb.">hora que enciende</option>
				  <option value="Db.">día que enciende</option>
				</select>
				<input id ="input" type="text" class="input" placeholder="...">
				<button class="connectButton" onclick="send()">Enviar</button>
                <p class="gray-label">Último valor enviado: <span id="valueSent"></span></p>
				<p class="gray-label">Última lectura: <span id="timestamp"></span></p>
			
			
			
			
			
			</div> 
        </div> <!-- 0.1 -->
		
		
        <div class="card-grid">  <!-- <br>0.2 -->
            <div class="card1">
                <h2>Resultado</h2><button id="borrraButton" class="onButton" onclick="retrievedValue.innerHTML='';">Borrar</button>
                <p class="reading"><span id="valueContainer">NaN</span></p>
                
            </div>

            
		
        </div> <!-- 0.2 -->
		
		
   </div> <!--  0 -->
    <div class="footer">
        <p><a href="https://randomnerdtutorials.com/">Created by RandomNerdTutorials.com</a></p>
        <p><a href="https://randomnerdtutorials.com/esp32-web-bluetooth/">Read the full project here.</a></p>
    </div>

<script>
    // DOM Elements
    const connectButton = document.getElementById('connectBleButton');
    const disconnectButton = document.getElementById('disconnectBleButton');
    const onButton = document.getElementById('onButton');
    const offButton = document.getElementById('offButton');
	const regarButton = document.getElementById('regarButton');
    const infoButton = document.getElementById('infoButton');
	const relojButton = document.getElementById('relojButton');
    const retrievedValue = document.getElementById('valueContainer');
    const latestValueSent = document.getElementById('valueSent');
    const bleStateContainer = document.getElementById('bleState');
    const timestampContainer = document.getElementById('timestamp');
	const inputEnviar = document.getElementById('input');
	const ordenesSelect = document.getElementById('ordenes');

   //Definir especificaciones del dispositivo BLE
    var deviceName ='ESP32RiegoBLE6';
    var bleService = '19b10000-e8f2-537e-4f6c-d104768a1214';
    var ledCharacteristic = '19b10002-e8f2-537e-4f6c-d104768a1214';
    var sensorCharacteristic= '19b10001-e8f2-537e-4f6c-d104768a1214';

   //Variables globales para manejar Bluetooth
    var bleServer;
    var bleServiceFound;
    var sensorCharacteristicFound;

    // Botón Conectar (busca dispositivos BLE solo si BLE está disponible)
    connectButton.addEventListener('click', (event) => {
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });

    // Botón de desconexión
    disconnectButton.addEventListener('click', disconnectDevice);

    // Escribe en la característica de los botones
    onButton.addEventListener('click', () => writeOnCharacteristic("1.1"));
    offButton.addEventListener('click', () => writeOnCharacteristic("0.1"));
	regarButton.addEventListener('click', () => writeOnCharacteristic("Regar.1"));
    infoButton.addEventListener('click', () => writeOnCharacteristic("Info.1"));
	relojButton.addEventListener('click', () => freloj());
	// pone valor seleccionado en input
	function  fseleccionar() {
		inputEnviar.value= ordenesSelect.value;
	}	

//COPIA HORA ACTUAL AL INPUT
	function   freloj() {
		var mfecha=  new Date();
		var sfecha= 'Fecha.' +mfecha.getDate() + ',' + (mfecha.getMonth() + 1) +
		',' + mfecha.getFullYear() + ',' + mfecha.getHours() + ',' + mfecha.getMinutes();
	     
		inputEnviar.value = sfecha;
	}

    // Comprueba si BLE está disponible en tu navegador
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
            console.log('¡La API web Bluetooth no está disponible en este navegador!');
            bleStateContainer.innerHTML = "¡La API web de Bluetooth no está disponible en este navegador/dispositivo!";
            return false
        }
        console.log('La API web de Bluetooth es compatible con este navegador.');
        return true
    }

    // Conectarse al dispositivo BLE y habilitar las notificaciones
    function connectToDevice(){
        console.log('Initializing Bluetooth...');
        navigator.bluetooth.requestDevice({
            filters: [{name: deviceName}],
            optionalServices: [bleService]
        })
        .then(device => {
            console.log('Device Selected:', device.name);
            bleStateContainer.innerHTML =  device.name; //'Connected to device ' +
            bleStateContainer.style.color = "#24af37";
            device.addEventListener('gattservicedisconnected', onDisconnected);
            return device.gatt.connect();
        })
        .then(gattServer =>{
            bleServer = gattServer;
            console.log("Connected to GATT Server");
            return bleServer.getPrimaryService(bleService);
        })
        .then(service => {
            bleServiceFound = service;
            console.log("Service discovered:", service.uuid);
            return service.getCharacteristic(sensorCharacteristic);
        })
        .then(characteristic => {
            console.log("Characteristic discovered:", characteristic.uuid);
            sensorCharacteristicFound = characteristic;
            characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicChange);
            characteristic.startNotifications();
            console.log("Notifications Started.");
            return characteristic.readValue();
        })
        .then(value => {
            console.log("Read value: ", value);
            const decodedValue = new TextDecoder().decode(value);
            console.log("Decoded value: ", decodedValue);
            retrievedValue.innerHTML =  decodedValue;            
        })
        .catch(error => {
            console.log('Error: ', error);
        })
    }

//DESCONECTA
    function onDisconnected(event){
        console.log('Device Disconnected:', event.target.device.name);
        bleStateContainer.innerHTML = "Device disconnected";
        bleStateContainer.style.color = "#d13a30";

        connectToDevice();
    }

    function handleCharacteristicChange(event){
        const newValueReceived = new TextDecoder().decode(event.target.value);
        console.log("Characteristic value changed: ", newValueReceived);
		console.log("event: ", event);
		retrievedValue.innerHTML = retrievedValue.innerHTML +"<br><br>" + newValueReceived; 
       // retrievedValue.innerHTML = newValueReceived;
        timestampContainer.innerHTML = getDateTime();
    }
	
/*	
	function writeSomethingLED1(data) {
  const service =  this.device.gatt.getPrimaryService("19b10000-e8f2-537e-4f6c-d104768a1214");
  const characteristic =  service.getCharacteristic("19b10001-e8f2-537e-4f6c-d104768a1214");
   characteristic.writeValue(data);
}
*/

function send(){
	//
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(ledCharacteristic)
			//bleServiceFound.getCharacteristic(sensorCharacteristic)
            .then(characteristic => {
                console.log("Found the LED characteristic: ", characteristic.uuid);
				var data = document.getElementById("input").value;
			return  characteristic.writeValue(buffer_str(data+"\n"))
            })
            .then(() => {
                latestValueSent.innerHTML = document.getElementById("input").value;//value;
                console.log("Value written to LEDcharacteristic:", document.getElementById("input").value);
            })
            .catch(error => {
                console.error("Error writing to the LED characteristic: ", error);
            });
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
    }



//envia botones
    function writeOnCharacteristic(value){
	//
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(ledCharacteristic)
			//bleServiceFound.getCharacteristic(sensorCharacteristic)
            .then(characteristic => {
                console.log("Found the LED characteristic: ", characteristic.uuid);
				return  characteristic.writeValue(buffer_str(value+"\n"))
			   //return characteristic.writeValue(value);
			   //characteristic.writeValue(value);
				
            })
            .then(() => {
                latestValueSent.innerHTML = value;
                console.log("Value written to LEDcharacteristic:", value);
            })
            .catch(error => {
                console.error("Error writing to the LED characteristic: ", error);
            });
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
    }

/*
function str2ab(str) {

    //var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
    //var bufView = new Uint16Array(buf);
	    var buf = new ArrayBuffer(str.length); // 1 bytes for each char
    var bufView = new Uint8Array(buf);
    for (var i=0, strLen=str.length; i<strLen; i++) {
        bufView[i] = str.charCodeAt(i);
    }
    return buf;
}
*/
//-----------------------------
//manda buffer como string
function buffer_str(tex) {
	var ArrBuf = new ArrayBuffer(tex.length); // 1 bytes for each char
    var VerBuffer = new Uint8Array(ArrBuf);
    for (var i=0, texLen=tex.length; i<texLen; i++) {
        VerBuffer[i] = tex.charCodeAt(i);
    }
    return ArrBuf;
}


//-----------------------------
    function disconnectDevice() {
        console.log("Disconnect Device.");
        if (bleServer && bleServer.connected) {
            if (sensorCharacteristicFound) {
                sensorCharacteristicFound.stopNotifications()
                    .then(() => {
                        console.log("Notifications Stopped");
                        return bleServer.disconnect();
                    })
                    .then(() => {
                        console.log("Device Disconnected");
                        bleStateContainer.innerHTML = "Device Disconnected";
                        bleStateContainer.style.color = "#d13a30";

                    })
                    .catch(error => {
                        console.log("An error occurred:", error);
                    });
            } else {
                console.log("No characteristic found to disconnect.");
            }
        } else {
            // Throw an error if Bluetooth is not connected
            console.error("Bluetooth is not connected.");
            window.alert("Bluetooth is not connected.")
        }
    }

    function getDateTime() {
        var currentdate = new Date();
        var day = ("00" + currentdate.getDate()).slice(-2); // Convert day to string and slice
        var month = ("00" + (currentdate.getMonth() + 1)).slice(-2);
        var year = currentdate.getFullYear();
        var hours = ("00" + currentdate.getHours()).slice(-2);
        var minutes = ("00" + currentdate.getMinutes()).slice(-2);
        var seconds = ("00" + currentdate.getSeconds()).slice(-2);
        
        var datetime = day + "/" + month + "/" + year + " at " + hours + ":" + minutes + ":" + seconds;
        return datetime;
    }


</script>

<!--  0 
<div allow="camera" style="width: 730px; height: 600px; position: fixed; z-index: 100000; background: rgb(142, 84, 84); bottom: -600px; transition: bottom 0.3s linear;"><div style="height: 10px; width: 100px; position: absolute; right: 0px; top: -10px; border-radius: 150px 150px 19px 19px; background-image: url(&quot;data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNi4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB3aWR0aD0iNHB4IiBoZWlnaHQ9IjRweCIgdmlld0JveD0iMCAwIDQgNCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgNCA0IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxsaW5lIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0FCQUJBQiIgc3Ryb2tlLXdpZHRoPSIwLjUiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgeDE9IjAiIHkxPSIwIiB4Mj0iNCIgeTI9IjQiLz4NCjwvc3ZnPg0K&quot;); background-repeat: repeat; background-position: 0px 0px; background-size: 4px 4px; text-align: center; cursor: pointer; background-color: rgba(255, 255, 255, 0.43);"></div><iframe src="./ESP32 Web BLE App_files/tabs.html" style="width: 100%; height: 100%; border: none;"></iframe></div><div style="position: absolute; border: 1px solid rgb(255, 0, 0);"></div>
-->
</body></html>
